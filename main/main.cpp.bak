#pragma once
#include "misc.h"
#include "project_config.h"
#include "FreeRTOS.h"
#include "task.h"
#include "queue.h"
#include "portable.h"

int state = 0;

int main(void)
{
  SystemInit();
  RCC_AHB1PeriphClockCmd(RCC_AHB1Periph_GPIOA, ENABLE);
  RCC_AHB1PeriphClockCmd(RCC_AHB1Periph_GPIOD, ENABLE);
  RCC_APB2PeriphClockCmd(RCC_APB2Periph_SYSCFG, ENABLE);
  
  
//  GPIO_InitTypeDef Pin;
//  Pin.GPIO_Pin = GPIO_Pin_13;
//  Pin.GPIO_Mode = GPIO_Mode_IN;
//  Pin.GPIO_Speed = GPIO_Speed_100MHz;
//  Pin.GPIO_OType = GPIO_OType_PP;
//  Pin.GPIO_PuPd = GPIO_PuPd_UP;
//  GPIO_Init(GPIOD, &Pin);
//  
//  SYSCFG_EXTILineConfig(EXTI_PortSourceGPIOD, EXTI_PinSource13);
//  
//  EXTI_InitTypeDef EXTI_Init_Struct;
//  EXTI_Init_Struct.EXTI_Line = EXTI_Line13;
//  EXTI_Init_Struct.EXTI_Mode = EXTI_Mode_Interrupt;
//  EXTI_Init_Struct.EXTI_Trigger = EXTI_Trigger_Rising;
//  EXTI_Init_Struct.EXTI_LineCmd = ENABLE;
//  EXTI_Init(&EXTI_Init_Struct);
//  
//  NVIC_InitTypeDef NVIC_struct;
//  NVIC_struct.NVIC_IRQChannel = EXTI15_10_IRQn;
//  NVIC_struct.NVIC_IRQChannelPreemptionPriority = 0x0f;
//  NVIC_struct.NVIC_IRQChannelSubPriority = 0x0f;
//  NVIC_struct.NVIC_IRQChannelCmd = ENABLE;
//  NVIC_Init(&NVIC_struct);
  
  RCC->AHB1ENR |= RCC_AHB1ENR_GPIOAEN;
  GPIOA->MODER &= ~GPIO_MODER_MODER1;
  GPIOA->MODER |= GPIO_MODER_MODER1_0;
  GPIOA->PUPDR &= ~GPIO_PUPDR_PUPDR1; 
  GPIOA->PUPDR |= GPIO_PUPDR_PUPDR1_0;
  
  while(true)
  {
    GPIOA->BSRRL = GPIO_BSRR_BS_1;
    for(int i = 0; i<10000000; ++i);
    GPIOA->BSRRH = GPIO_BSRR_BS_1;
    for(int i = 0; i<10000000; ++i);
  }
//  GPIO_InitTypeDef Pin2;
//  Pin2.GPIO_Pin = GPIO_Pin_9;
//  Pin2.GPIO_Mode = GPIO_Mode_OUT;
//  Pin2.GPIO_Speed = GPIO_Speed_100MHz;
//  Pin2.GPIO_OType = GPIO_OType_PP;
//  Pin2.GPIO_PuPd = GPIO_PuPd_UP;
//  GPIO_Init(GPIOE, &Pin2);
  
  //xTaskCreate(f1, "blinker", configMINIMAL_STACK_SIZE, NULL, tskIDLE_PRIORITY+1, NULL);
  //xTaskCreate(f2, "blinker2", configMINIMAL_STACK_SIZE, NULL, tskIDLE_PRIORITY+1, NULL);
  //vTaskStartScheduler();
}
//extern "C"
//{
//bool _state = 0;  
//void EXTI15_10_IRQHandler(void)
//{
//        // clear interrupt pending bit
//        EXTI_ClearITPendingBit(EXTI_Line13);
//        if(_state)
//          GPIOE->BSRRL = GPIO_BSRR_BS_9;
//        else
//          GPIOE->BSRRH = GPIO_BSRR_BS_9;
//        _state = abs(_state - 1.0);
//        for(int i = 0; i<10000; i++);
//        // user code - handle rising edge event here
//}
//}